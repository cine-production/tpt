<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ThemeParkTravellers</title>
    <link rel="shortcut icon"
        href="https://yt3.googleusercontent.com/n6auAEfZNK_SRWqHQfzn-4xhz4T4NUDIfcUmjEZPKBZho8rXP7OfTn5isJdU2EscA=s160-c-k-c0x00ffffff-no-rj"
        type="image/x-icon">
    <link rel="apple-touch-icon"
        href="https://yt3.googleusercontent.com/n6auAEfZNK_SRWqHQfzn-4xhz4T4NUD2UbLSaXf59diUmjEZPKBZho8rXP7OfTn5isJdU2EscA=s160-c-k-c0x00ffffff-no-rj">
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#5161ce">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="description" content="Une application PWA simple">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: { primary: "#1E40AF", secondary: "#F59E0B" },
            borderRadius: {
              none: "0px",
              sm: "4px",
              DEFAULT: "8px",
              md: "12px",
              lg: "16px",
              xl: "20px",
              "2xl": "24px",
              "3xl": "32px",
              full: "9999px",
              button: "8px",
            },
          },
        },
      };
    </script>
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap"
      rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap"
      rel="stylesheet" />
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" />
    <!-- Firebase SDK (Modulaire) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
      import { getFirestore, collection, query, where, orderBy, limit, getDocs, getDoc, setDoc, updateDoc, deleteDoc, doc, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

      // Configuration Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyD1EGHhEUamTow1UPtPQWD-uiElBogQ66g",
        authDomain: "tp-travelers.firebaseapp.com",
        projectId: "tp-travelers",
        storageBucket: "tp-travelers.firebasestorage.app",
        messagingSenderId: "419470405151",
        appId: "1:419470405151:web:b3f495a0b5857685ff2f2a"
      };

      // Initialisation Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Exposer les objets nécessaires globalement
      window.firebaseApp = {
        auth, db, onAuthStateChanged, signInWithEmailAndPassword,
        createUserWithEmailAndPassword, signOut, deleteUser,
        collection, query, where, orderBy, limit,
        getDocs, getDoc, setDoc, updateDoc, deleteDoc, doc, serverTimestamp,
        addDoc
      };
    </script>
    <style>
      :where([class^="ri-"])::before { content: "\f3c2"; }
      body {
        font-family: 'Nunito', sans-serif;
        padding-bottom: 105px;
        padding-top: 60px;
      }
      .hidden { display: none; }
      .avatar-option:hover {
  transform: scale(1.1);
  transition: transform 0.2s ease;
}
#avatar-preview {
  transition: opacity 0.3s ease;
}
#avatar-selection-modal img {
  object-fit: cover;
}
.event-markers {
  position: absolute;
  bottom: 20px;
  width: 100%;
  display: flex;
  flex-direction: row;
  justify-content: center;
  gap: 2px;
  z-index: 11;
}
.multi-day-markers {
  position: absolute;
  bottom: 4px;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  z-index: 10;
}
.event-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  z-index: 11;
}
.multi-day-part {
  position: relative;
}
.multi-day-bar {
  position: absolute;
  height: 3px;
  width: 100%;
  left: 0;
  z-index: 10;
  border-radius: 1.5px;
  transition: all 0.2s ease;
}
.switch {
  width: 40px;
  height: 20px;
  background: #ccc;
  border-radius: 10px;
  position: relative;
  cursor: pointer;
}
.switch:checked {
  background: #4CAF50;
}
.switch:checked::after {
  transform: translateX(20px);
}
.switch::after {
  content: '';
  width: 16px;
  height: 16px;
  background: white;
  border-radius: 50%;
  position: absolute;
  top: 2px;
  left: 2px;
  transition: transform 0.3s;
}
.page-content {
  position: relative;
}
.absolute {
  position: absolute;
}
.transform {
  transform: translateX(0);
}
.transition-transform {
  transition: transform 0.3s ease-in-out;
}
.translate-x-full {
  transform: translateX(100%);
}
.bg-opacity-80 {
  background-color: rgba(255, 255, 255, 0.8);
}
.backdrop-blur-sm {
  backdrop-filter: blur(4px); /* Ajustez la valeur si besoin */
}
.page-content {
  position: relative;
  height: calc(100vh - 120px); /* Ajuster pour les navbars fixes */
  /* overflow-y: auto; */
}
/* Style pour la page latérale */
#toilets-detail-page {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: #fff;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  transform: translateX(100%);
  transition: transform 0.5s ease-in-out;
  z-index: 49;
  padding: 80px 20px 100px;
  overflow-y: auto;
}

#toilets-detail-page.active {
  transform: translateX(0);
}

nav.nav {
  z-index: 50;
}

.no-scroll {
  overflow: hidden;
}

nav.top-nav {
  z-index: 50;
}
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Navigation supérieure -->
    <nav class="fixed top-0 left-0 w-full bg-white shadow-md z-50 top-nav">
      <div class="flex items-center justify-between px-4 py-3">
        <h1 class="text-2xl font-['Pacifico'] text-primary">logo</h1>
        <div class="flex items-center space-x-3">
          <button id="notification-btn" style="display: none;"
            class="w-8 h-8 flex items-center justify-center text-gray-600">
            <i class="ri-notification-3-line ri-lg"></i>
          </button>
          <button id="user-btn"
            class="w-8 h-8 flex items-center justify-center text-gray-600"
            disabled>
            <i class="ri-user-line ri-lg"></i>
          </button>
        </div>
      </div>
    </nav>

    <!-- Contenu principal -->
    <div id="main-content" class="px-4 py-4">
      <!-- Page principale (Accueil) -->
      <div id="home-page" class="page-content">
        <!-- SECTION EN LIVE -->
        <div id="live-banner-container" class="mb-6 hidden">
          <div
            class="flex flex-col md:flex-row md:items-center md:justify-between bg-red-500 text-white px-5 py-4 rounded-xl shadow-md animate-fade-in">
            <div class="flex items-center space-x-3">
              <div class="relative">
                <span
                  class="absolute inline-flex h-3 w-3 rounded-full bg-white opacity-75 animate-ping"></span>
                <span
                  class="relative inline-flex rounded-full h-3 w-3 bg-white"></span>
              </div>
              <span class="text-lg font-bold tracking-wide">EN LIVE</span>
            </div>
            <div class="mt-3 md:mt-0 flex gap-3">
              <a id="live-banner-link" href="#" target="_blank"
                class="bg-white text-red-600 px-4 py-2 rounded-button text-sm font-medium hover:bg-gray-100 transition">
                Rejoindre le live
              </a>
              <button id="edit-live-banner"
                class="hidden bg-white text-blue-600 px-4 py-2 rounded-button text-sm font-medium hover:bg-blue-50 transition">
                Modifier
              </button>
              <button id="stop-live-banner"
                class="hidden bg-white text-red-600 px-4 py-2 rounded-button text-sm font-medium hover:bg-red-50 transition">
                Arrêter
              </button>
            </div>
          </div>
        </div>

        <!-- Bouton Définir en LIVE -->
        <div class="mb-4 hidden" id="set-live-admin-container">
          <!-- <button id="set-live-btn"
            class="px-4 py-2 bg-primary text-white rounded-button text-sm font-medium">
            Définir en LIVE
          </button> -->
        </div>

        <div class="mb-8">
          <h2 class="text-xl font-bold text-gray-800 mb-3">Derniers Lives
            YouTube</h2>
          <div id="live-events"
            class="flex space-x-4 overflow-x-auto pb-2"></div>
        </div>

        <hr class="my-6 border-gray-200" />

        <!-- ACTUALITÉS -->
        <div class="mb-8">
          <div class="flex justify-between items-center mb-3">
            <h2 class="text-xl font-bold text-gray-800">Actualités</h2>
            <!-- <button id="add-news-btn" style="display: none;"
              class="px-3 py-2 bg-primary text-white rounded-button text-sm flex items-center space-x-1 cursor-pointer hidden">
              <i
                class="ri-add-line w-4 h-4 flex items-center justify-center"></i>
              <span>Ajouter une actu</span>
            </button> -->
          </div>
          <div id="news-section" class="space-y-4"></div>
        </div>
      </div>

      <!-- Page Calendrier -->
      <div id="calendar-page" class="page-content hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800">Calendrier des
            Événements</h2>
          <div class="flex space-x-2">
            <button id="filter-btn"
              class="px-3 py-2 bg-white border border-gray-200 rounded-button text-sm flex items-center space-x-1 cursor-pointer">
              <i
                class="ri-filter-3-line w-4 h-4 flex items-center justify-center"></i>
              <span>Filtrer</span>
            </button>

          </div>
        </div>
        <!-- Filtre Modal -->
        <div id="filter-modal"
          class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
          <div class="bg-white rounded-md p-6 m-4 max-w-sm w-full">
            <h3 class="text-md font-semibold mb-4">Filtrer les événements</h3>
            <div class="space-y-2">
              <button
                class="filter-option w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-button hover:bg-gray-200"
                data-filter="all">Tous</button>
              <button
                class="filter-option w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-button hover:bg-gray-200"
                data-filter="Live">Live</button>
              <button
                class="filter-option w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-button hover:bg-gray-200"
                data-filter="Visite">Visite</button>
              <button
                class="filter-option w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-button hover:bg-gray-200"
                data-filter="Food">Food</button>
              <button
                class="filter-option w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-button hover:bg-gray-200"
                data-filter="Nocturne">Nocturne</button>
            </div>
            <button id="close-filter-modal"
              class="w-full mt-4 bg-primary text-white py-2 rounded-button">Fermer</button>
          </div>
        </div>
        <!-- Sélecteur de mois -->
        <div
          class="flex justify-between items-center mb-4 bg-white rounded-md p-3 shadow-sm">
          <button id="prev-month"
            class="w-8 h-8 flex items-center justify-center text-gray-600 cursor-pointer">
            <i class="ri-arrow-left-s-line ri-lg"></i>
          </button>
          <h3 id="month-display" class="text-base font-semibold">Juin 2025</h3>
          <button id="next-month"
            class="w-8 h-8 flex items-center justify-center text-gray-600 cursor-pointer">
            <i class="ri-arrow-right-s-line ri-lg"></i>
          </button>
        </div>
        <!-- Jours de la semaine -->
        <div class="grid grid-cols-7 text-center text-xs text-gray-500 mb-2">
          <div>Lun</div>
          <div>Mar</div>
          <div>Mer</div>
          <div>Jeu</div>
          <div>Ven</div>
          <div>Sam</div>
          <div>Dim</div>
        </div>
        <!-- Calendrier -->
        <div id="calendar-grid" class="grid grid-cols-7 gap-1 mb-6"></div>
        <!-- Événements du jour -->
        <h3 id="events-title" class="text-md font-semibold mb-3">Événements du
          19 Juin</h3>
        <div id="event-list" class="space-y-3 mb-8 event-list"></div>
        <!-- Événements à venir -->
        <h3 class="text-md font-semibold mb-3">Prochains événements</h3>
        <div id="upcoming-events" class="space-y-3"></div>
      </div>

      <!-- Page Évaluations -->
      <div id="ratings-page" class="page-content hidden">
        <h2 class="text-xl font-bold text-gray-800 mb-6">Évaluations</h2>
        <div id="ratings-list" class="space-y-4"></div>
        <!-- <button id="add-rating-btn"
          class="mt-4 px-4 py-2 bg-primary text-white rounded-button w-full hidden">
          Ajouter une évaluation
        </button> -->
      </div>

      <!-- Page Toilettes -->
      <div id="toilets-page" class="page-content hidden">
        <h2 class="text-xl font-bold text-gray-800 mb-6">Toilettes des Parcs
          Disney</h2>
        <div id="park-toilets" class="space-y-4">
          <!-- Blocs pour chaque parc seront générés dynamiquement -->
        </div>
      </div>

      <!-- Page Plus (Réseaux sociaux) -->
      <div id="more-page" class="page-content hidden">
        <h2 class="text-xl font-bold text-gray-800 mb-6">Nos Réseaux
          Sociaux</h2>
        <div class="grid grid-cols-2 gap-4">
          <a href="https://www.youtube.com/@DisneyParksExplorer" target="_blank"
            class="flex items-center space-x-3 bg-white rounded-md p-4 shadow-sm hover:bg-gray-100">
            <i class="ri-youtube-fill text-red-500 text-2xl"></i>
            <span class="text-gray-800 font-medium">YouTube</span>
          </a>
          <a href="https://x.com/DisneyParksExplorer" target="_blank"
            class="flex items-center space-x-3 bg-white rounded-md p-4 shadow-sm hover:bg-gray-100">
            <i class="ri-twitter-x-fill text-black text-2xl"></i>
            <span class="text-gray-800 font-medium">X</span>
          </a>
          <a href="https://www.instagram.com/DisneyParksExplorer"
            target="_blank"
            class="flex items-center space-x-3 bg-white rounded-md p-4 shadow-sm hover:bg-gray-100">
            <i class="ri-instagram-fill text-pink-500 text-2xl"></i>
            <span class="text-gray-800 font-medium">Instagram</span>
          </a>
          <a href="https://www.tiktok.com/@DisneyParksExplorer" target="_blank"
            class="flex items-center space-x-3 bg-white rounded-md p-4 shadow-sm hover:bg-gray-100">
            <i class="ri-tiktok-fill text-black text-2xl"></i>
            <span class="text-gray-800 font-medium">TikTok</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Navigation inférieure -->
    <!-- <nav class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 z-50">
        <div class="grid grid-cols-4 h-16">
            <a href="#home" class="nav-item flex flex-col items-center justify-center text-primary cursor-pointer" data-page="home-page">
                <div class="w-6 h-6 flex items-center justify-center">
                    <i class="ri-home-4-fill ri-lg"></i>
                </div>
                <span class="text-xs mt-1">Accueil</span>
            </a>
            <a href="#calendar" class="nav-item flex flex-col items-center justify-center text-gray-500 cursor-pointer" data-page="calendar-page">
                <div class="w-6 h-6 flex items-center justify-center">
                    <i class="ri-calendar-2-line ri-lg"></i>
                </div>
                <span class="text-xs mt-1">Calendrier</span>
            </a>
            <a href="#ratings" class="nav-item flex flex-col items-center justify-center text-gray-500 cursor-pointer" data-page="ratings-page">
                <div class="w-6 h-6 flex items-center justify-center">
                    <i class="ri-star-smile-line ri-lg"></i>
                </div>
                <span class="text-xs mt-1">Évaluations</span>
            </a>
            <a href="#more" class="nav-item flex flex-col items-center justify-center text-gray-500 cursor-pointer" data-page="more-page">
                <div class="w-6 h-6 flex items-center justify-center">
                    <i class="ri-links-line ri-lg"></i>
                </div>
                <span class="text-xs mt-1">Plus</span>
            </a>
        </div>
    </nav> -->

    <!-- NOUVELLE Navigation -->

    <nav class="nav">
      <ul class="nav__list">
        <li>
          <a href="#home" class="nav-item nav__link active-link"
            data-page="home-page">
            <i class="ri-home-smile-2-line"></i>
          </a>
        </li>

        <li>
          <a href="#calendar" class="nav__link nav-item"
            data-page="calendar-page">
            <i class="ri-calendar-2-line"></i>
          </a>
        </li>

        <li>
          <a href="#toilets" class="nav__link nav-item"
            data-page="toilets-page">
            <svg class="ri-restroom-fill" xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 448 512"><path
                d="M0 24C0 37.3 10.7 48 24 48l32 0 336 0 32 0c13.3 0 24-10.7 24-24s-10.7-24-24-24L392 0 56 0 24 0C10.7 0 0 10.7 0 24zM81.6 182.9l-1.6 .5L80 80 32 80l0 127.1-.4 .4C17.5 219.4 8 235.7 8 256c0 72.7 33.4 120.2 78.4 148.3c1.7 1.1 3.5 2.1 5.2 3.2L69.3 448.2c-3.5 6.3-5.3 13.5-5.3 20.7c0 23.8 19.3 43.1 43.1 43.1l233.8 0c23.8 0 43.1-19.3 43.1-43.1c0-7.2-1.8-14.4-5.3-20.7l-22.3-40.7c1.8-1 3.5-2.1 5.2-3.2c45-28.1 78.4-75.6 78.4-148.3c0-20.3-9.5-36.6-23.6-48.5l-.4-.4L416 80l-48 0 0 103.4-1.6-.5C328.4 172 277.7 168 224 168s-104.4 4-142.4 14.9zM373.8 326.8c-9.8 15.7-22.9 27.6-37.6 36.9C303 384.4 259.9 392 224 392s-79-7.6-112.2-28.3c-14.7-9.2-27.8-21.2-37.6-36.9c2.4 .8 4.9 1.5 7.4 2.3C119.6 340 170.3 344 224 344s104.4-4 142.4-14.9c2.5-.7 4.9-1.5 7.4-2.3zM56 256c0-3.7 1.2-7.4 6.6-12c6.1-5.1 16.5-10.4 32.3-15C126.3 220 171.6 216 224 216s97.7 4 129.1 13.1c15.8 4.5 26.2 9.8 32.2 15c5.4 4.6 6.6 8.2 6.6 12s-1.2 7.4-6.6 12c-6.1 5.1-16.5 10.4-32.2 15C321.7 292 276.4 296 224 296s-97.7-4-129.1-13.1c-15.8-4.5-26.2-9.8-32.3-15c-5.4-4.6-6.6-8.2-6.6-12zM312.3 426.8L332.6 464l-217.3 0 20.4-37.2c30.5 9.7 61.8 13.2 88.3 13.2s57.7-3.5 88.3-13.2zM128 80c-8.8 0-16 7.2-16 16s7.2 16 16 16l48 0c8.8 0 16-7.2 16-16s-7.2-16-16-16l-48 0z" /></svg>
          </a>
        </li>

        <!-- Expand list -->
        <li class="nav-expand-pri">
          <button class="hidden BtnAddAll nav__expand" id="nav-expand">
            <i class="ri-add-line nav__expand-icon" id="nav-expand-icon"></i>
          </button>

          <ul class="hidden BtnAddAll nav__expand-list" id="nav-expand-list">
            <button id="add-event-btn">
              <li>
                <a class="nav__expand-link ">
                  <i class="ri-calendar-event-line"></i>
                  <span>Actu</span>
                </a>
              </li>
            </button>
            <button id="set-live-btn">
              <li>
                <a class="nav__expand-link">
                  <i class="ri-live-line"></i>
                  <span>LIVE</span>
                </a>
              </li>
            </button>
            <button id="add-news-btn">
              <li>
                <a class="nav__expand-link">
                  <i class="ri-news-line"></i>
                  <span>News</span>
                </a>
              </li>
            </button>
            <button id="add-rating-btn">
              <li>
                <a class="nav__expand-link">
                  <i class="ri-star-line"></i>
                  <span>Avis</span>
                </a>
              </li>
            </button>
            <button id="add-ratingToilete-btn">
              <li>
                <a class="nav__expand-link">
                  <i class="ri-star-line"></i>
                  <span>Toilettes</span>
                </a>
              </li>
            </button>
            <!-- <button id="send-notification-btn">
        <li>
          <a class="nav__expand-link">
            <i class="ri-notification-3-line"></i>
            <span>Notif</span>
          </a>
        </li>
      </button> -->
          </ul>
        </li>

        <li>
          <a href="#toilets" class="nav__link nav-item"
            data-page="toilets-page">
            <svg class="ri-restroom-fill" xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 448 512"><path
                d="M0 24C0 37.3 10.7 48 24 48l32 0 336 0 32 0c13.3 0 24-10.7 24-24s-10.7-24-24-24L392 0 56 0 24 0C10.7 0 0 10.7 0 24zM81.6 182.9l-1.6 .5L80 80 32 80l0 127.1-.4 .4C17.5 219.4 8 235.7 8 256c0 72.7 33.4 120.2 78.4 148.3c1.7 1.1 3.5 2.1 5.2 3.2L69.3 448.2c-3.5 6.3-5.3 13.5-5.3 20.7c0 23.8 19.3 43.1 43.1 43.1l233.8 0c23.8 0 43.1-19.3 43.1-43.1c0-7.2-1.8-14.4-5.3-20.7l-22.3-40.7c1.8-1 3.5-2.1 5.2-3.2c45-28.1 78.4-75.6 78.4-148.3c0-20.3-9.5-36.6-23.6-48.5l-.4-.4L416 80l-48 0 0 103.4-1.6-.5C328.4 172 277.7 168 224 168s-104.4 4-142.4 14.9zM373.8 326.8c-9.8 15.7-22.9 27.6-37.6 36.9C303 384.4 259.9 392 224 392s-79-7.6-112.2-28.3c-14.7-9.2-27.8-21.2-37.6-36.9c2.4 .8 4.9 1.5 7.4 2.3C119.6 340 170.3 344 224 344s104.4-4 142.4-14.9c2.5-.7 4.9-1.5 7.4-2.3zM56 256c0-3.7 1.2-7.4 6.6-12c6.1-5.1 16.5-10.4 32.3-15C126.3 220 171.6 216 224 216s97.7 4 129.1 13.1c15.8 4.5 26.2 9.8 32.2 15c5.4 4.6 6.6 8.2 6.6 12s-1.2 7.4-6.6 12c-6.1 5.1-16.5 10.4-32.2 15C321.7 292 276.4 296 224 296s-97.7-4-129.1-13.1c-15.8-4.5-26.2-9.8-32.3-15c-5.4-4.6-6.6-8.2-6.6-12zM312.3 426.8L332.6 464l-217.3 0 20.4-37.2c30.5 9.7 61.8 13.2 88.3 13.2s57.7-3.5 88.3-13.2zM128 80c-8.8 0-16 7.2-16 16s7.2 16 16 16l48 0c8.8 0 16-7.2 16-16s-7.2-16-16-16l-48 0z" /></svg>
          </a>
        </li>
        <li>
          <a href="#ratings" class="nav__link nav-item"
            data-page="ratings-page">
            <i class="ri-gemini-line"></i>
          </a>
        </li>

        <li>
          <a href="#more" class="nav__link nav-item" data-page="more-page">
            <i class="ri-links-line"></i>
          </a>
        </li>
      </ul>
    </nav>

    <!-- Scripts -->
    <script id="app-functionality">
      document.addEventListener("DOMContentLoaded", function () {
        // Vérifier que Firebase est chargé
        if (!window.firebaseApp) {
          console.error("Firebase n'est pas chargé correctement");
          alert("Erreur de chargement de l'application. Veuillez recharger la page.");
          return;
        }
        console.log("Firebase initialized:", window.firebaseApp); // Debug Firebase initialization

        function convertToEmbedUrl(url) {
          if (!url) return null;
          const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/live\/)([a-zA-Z0-9_-]{11})/);
          return match ? `https://www.youtube.com/embed/${match[1]}` : url;
        }

        const { auth, db, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, collection, query, where, orderBy, limit, getDocs, getDoc, setDoc, updateDoc, deleteDoc, doc, serverTimestamp, addDoc, deleteUser } = window.firebaseApp;

        let currentUser = null;
        let userRole = null;
        let currentMonth = new Date(2025, 5); // Juin 2025
        let selectedDay = new Date().getDate();
        const adminEmail = "admin@example.com"; // Remplacez par votre email admin réel

        const userBtn = document.getElementById("user-btn");
        userBtn.disabled = true; // Disable button until auth state is resolved

        // Authentication state observer
        // Remplacez la section existante de onAuthStateChanged par ceci
onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  userRole = null;
  if (user) {
    const userDocRef = doc(db, "users", user.uid);
    const userDocSnap = await getDoc(userDocRef);
    if (userDocSnap.exists() && userDocSnap.data().avatar) {
      userBtn.innerHTML = `
        <img src="${userDocSnap.data().avatar}" class="w-8 h-8 rounded-full object-cover" alt="Avatar utilisateur">
      `;
      currentUser.avatar = userDocSnap.data().avatar;
      userRole = userDocSnap.data().role;
    } else {
      userBtn.innerHTML = `<i class="ri-user-line ri-lg"></i>`;
      userRole = userDocSnap.data()?.role || "user";
    }
    // Sauvegarder l'état de connexion localement
    localStorage.setItem("userId", user.uid);
  } else {
    userBtn.innerHTML = `<i class="ri-user-line ri-lg"></i>`;
    userBtn.disabled = false;
    localStorage.removeItem("userId");
    // Revenir à la page d'accueil si déconnecté
    showPage("home-page");
  }
  console.log("Auth state updated, currentUser:", currentUser, "userRole:", userRole);
  userBtn.disabled = false;
  const isAdmin = userRole === "admin";
  document.getElementById("add-event-btn").classList.toggle("hidden", !isAdmin);
  document.getElementById("add-rating-btn").classList.toggle("hidden", !isAdmin);
  document.getElementById("add-news-btn").classList.toggle("hidden", !isAdmin);
  document.getElementById("set-live-admin-container").classList.toggle("hidden", !isAdmin);
  document.querySelectorAll(".BtnAddAll").forEach(element => element.classList.toggle("hidden", !isAdmin));
  document.querySelectorAll(".nav-expand-pri").forEach(element => element.classList.toggle("hidden", !isAdmin));
  loadHomePage();
  loadRatings();
  loadCalendar(); // Recharger le calendrier pour refléter l'état d'authentification
});

    // Mapping des types de notifications aux tokens
    const notificationTopics = {
  Live: "live_topic",
  Événement: "event_topic",
  News: "news_topic"
};

// Initialiser et charger les préférences depuis Firestore
let userPreferences = { Live: false, Événement: false, News: false };
async function loadPreferences() {
  if (currentUser) {
    try {
      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      if (userDoc.exists()) {
        const data = userDoc.data();
        userPreferences = { ...userPreferences, ...data.notificationPrefs };
      }
      console.log("Préférences chargées:", userPreferences);
      await syncPreferencesWithSW();
    } catch (error) {
      console.error("Erreur lors du chargement des préférences:", error);
    }
  }
  return userPreferences;
}

// Fonction pour sauvegarder les préférences dans Firestore
async function savePreferences() {
  if (currentUser) {
    try {
      await setDoc(doc(db, "users", currentUser.uid), { notificationPrefs: userPreferences }, { merge: true });
      console.log("Préférences sauvegardées:", userPreferences);
      await syncPreferencesWithSW();
    } catch (error) {
      console.error("Erreur lors de la sauvegarde des préférences:", error);
    }
  }
}

// Fonction pour synchroniser les préférences avec le Service Worker
async function syncPreferencesWithSW() {
  if ('serviceWorker' in navigator) {
    const registration = await navigator.serviceWorker.ready;
    registration.active.postMessage({
      type: 'updatePreferences',
      preferences: userPreferences
    });
    console.log('Préférences synchronisées avec Service Worker:', userPreferences);
  }
}

// Fonction pour demander l'autorisation des notifications
function requestNotificationPermission(type) {
  if (Notification.permission === 'default') {
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        console.log(`Autorisation accordée pour les notifications de type ${type}`);
        userPreferences[type] = true;
        savePreferences();
      } else {
        console.log(`Autorisation refusée pour les notifications de type ${type}`);
      }
    });
  } else if (Notification.permission === 'granted') {
    userPreferences[type] = true;
    savePreferences();
  }
}

document.querySelectorAll('[data-park-id]').forEach(item => {
  item.addEventListener('click', () => showToiletDetails(item.getAttribute('data-park-id')));
});

document.querySelector('[data-page="toilets-page"]').addEventListener("click", loadToiletsPage);

async function loadToiletsPage() {
  const parkToilets = document.getElementById("park-toilets");
  if (!parkToilets) {
    console.error("Élément park-toilets non trouvé dans le DOM");
    return;
  }
  parkToilets.innerHTML = '<p class="text-gray-600">Chargement...</p>';

  try {
    const parks = [
      { id: "disneyland-paris", name: "Disneyland Paris", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/8e/Disneyland_Resort_logo.svg/1200px-Disneyland_Resort_logo.svg.png" },
      { id: "epcot", name: "EPCOT", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/8e/Disneyland_Resort_logo.svg/1200px-Disneyland_Resort_logo.svg.png" },
    ];

    parkToilets.innerHTML = '';

    parks.forEach(park => {
      const parkElement = document.createElement("div");
      parkElement.className = "bg-white rounded-md p-4 shadow-sm flex justify-between items-center cursor-pointer group";
      parkElement.setAttribute("data-park-id", park.id);
      parkElement.innerHTML = `
        <div class="flex items-center space-x-3">
          ${park.logo ? `<img src="${park.logo}" alt="${park.name} Logo" class="w-10 h-10 object-contain">` : ''}
          <span class="text-gray-800 font-medium">${park.name}</span>
        </div>
        <i class="ri-arrow-right-s-line text-gray-500"></i>
      `;
      parkToilets.appendChild(parkElement);
    });

    // Ajouter les écouteurs après avoir créé les éléments
    const parkElements = document.querySelectorAll('[data-park-id]');
    parkElements.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        console.log("Clic détecté sur :", item.getAttribute('data-park-id')); // Débogage
        showToiletDetails(item.getAttribute('data-park-id'));
      });
    });
    console.log("Écouteurs attachés à :", parkElements.length, "éléments");
  } catch (error) {
    console.error("Erreur lors du chargement des toilettes :", error);
    parkToilets.innerHTML = '<p class="text-red-500">Erreur de chargement</p>';
  }
}

// Fonction séparée pour attacher les écouteurs
function attachParkListeners() {
  document.querySelectorAll('[data-park-id]').forEach(item => {
    item.addEventListener('click', (e) => {
      e.preventDefault();
      console.log("Clic détecté sur :", item.getAttribute('data-park-id'));
      showToiletDetails(item.getAttribute('data-park-id'));
    });
  });
}

  function showToiletDetails(parkId) {
  let detailPage = document.getElementById("toilets-detail-page");
  if (!detailPage) {
    detailPage = document.createElement("div");
    detailPage.id = "toilets-detail-page";
    detailPage.className = "toilets-detail-page"; // Appliquer une classe pour les styles CSS
    document.body.appendChild(detailPage);
    console.log("Nouveau élément créé :", detailPage);
  } else {
    // Réinitialiser l'élément existant
    detailPage.classList.remove("active");
    detailPage.innerHTML = ""; // Vider le contenu
    console.log("Élément existant réinitialisé :", detailPage);
  }

  const toiletPosts = {
    "disneyland-paris": [
      { id: 1, location: "Disneyland Park - Near Sleeping Beauty Castle", text: "Très propres et bien entretenues !", date: "2025-06-29" },
      { id: 2, location: "Disneyland Park - Main Street", text: "Longue file d'attente aujourd'hui.", date: "2025-06-28" },
      { id: 3, location: "Disney Studios - Near Tower of Terror", text: "Propre et accessible.", date: "2025-06-27" },
      { id: 4, location: "Disney Studios - Animation Courtyard", text: "Un peu encombré en ce moment.", date: "2025-06-26" },
      { id: 5, location: "Disney Studios - Backlot", text: "Calme et propre.", date: "2025-06-25" },
      { id: 6, location: "Disneyland Park - Adventureland", text: "Assez fréquenté.", date: "2025-06-24" }
    ],
    "epcot": [
      { id: 1, location: "Disneyland Park - Near Sleeping Beauty Castle", text: "Très propres et bien entretenues !", date: "2025-06-29" },
      { id: 2, location: "Disneyland Park - Main Street", text: "Longue file d'attente aujourd'hui.", date: "2025-06-28" }
    ]
  };

  const posts = toiletPosts[parkId] || [];
  detailPage.innerHTML = `
    <button class="top-4 left-4 px-4 py-2 bg-gray-200 text-gray-800 rounded-button" onclick="document.getElementById('toilets-detail-page').classList.remove('active'); document.body.classList.remove('no-scroll')">Retour</button>
    <h3 class="text-xl font-bold text-gray-800 mb-4 mt-8 text-center">Toilettes - ${parkId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
    <div class="px-4">
      ${posts.length > 0 ? posts.map(post => `
        <div class="bg-white rounded-md p-4 shadow-sm mb-4">
          <p class="text-gray-700"><strong>${post.location}</strong></p>
          <p class="text-gray-700 mt-1">${post.text}</p>
          <p class="text-sm text-gray-500 mt-2">${new Date(post.date).toLocaleDateString('fr-FR')}</p>
        </div>
      `).join('') : '<p class="text-gray-600 text-center">Aucune publication disponible.</p>'}
    </div>
  `;

  // Forcer un reflow avant d'ajouter la classe active
  detailPage.offsetHeight;
  setTimeout(() => {
    detailPage.classList.add("active");
    document.body.classList.add("no-scroll");
    console.log("Classe active ajoutée, élément :", detailPage);
  }, 50);

  console.log("Détails affichés pour :", parkId);
}




// Fonction pour envoyer une notification via ntfy.sh avec topic
async function sendNotification(title, message, priority, type, topic) {
  const url = `https://ntfy.sh/${topic}`;
  console.log(`Tentative d'envoi à ${url}, titre: ${title}, message: ${message}, priorité: ${priority}, type: ${type}`);
  try {
    const response = await fetch(url, {
      method: "POST",
      headers: { 
        "Content-Type": "text/plain",
        "Priority": priority // ntfy.sh accepte les priorités via en-tête (1-5)
      },
      body: message
    });
    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
    console.log("Notification envoyée avec succès");
    return response;
  } catch (error) {
    console.error(`Erreur pour le topic ${topic}:`, error.message);
    throw error;
  }
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('message', event => {
    if (event.data.type === 'newNotification') {
      const { topic, message } = event.data;
      let type = '';
      if (topic === 'live_topic') type = 'Live';
      if (topic === 'event_topic') type = 'Événement';
      if (topic === 'news_topic') type = 'News';

      if (userPreferences[type]) {
        alert(`Nouvelle notification (${type}): ${message}`);
        // Vous pouvez aussi ajouter un élément DOM pour une interface plus élégante
        const notificationDiv = document.createElement('div');
        notificationDiv.textContent = `(${type}) ${message}`;
        notificationDiv.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #fff; padding: 10px; border: 1px solid #ccc; z-index: 1000;';
        document.body.appendChild(notificationDiv);
        setTimeout(() => notificationDiv.remove(), 5000); // Supprime après 5 secondes
      }
    }
  });
}

// Fonction pour afficher le modal de notification
function showNotificationModal() {
  if (!currentUser || userRole !== "admin") {
    alert("Vous devez être administrateur pour envoyer des notifications");
    return;
  }

  const modal = document.createElement("div");
  modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
  modal.innerHTML = `
    <div class="bg-white rounded-md p-6 m-4 max-w-md w-full">
      <form id="notificationForm" class="space-y-4">
        <h3 class="text-md font-semibold text-gray-800 mb-4">Envoyer une notification</h3>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Titre</label>
          <input type="text" name="title" required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Message</label>
          <textarea name="body" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Priorité (1-5)</label>
          <input type="number" name="priority" min="1" max="5" value="5" required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Type(s) de notification</label>
          <select name="types" multiple required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary h-24">
            <option value="Live">Live</option>
            <option value="Événement">Événement</option>
            <option value="News">News</option>
          </select>
        </div>
        <div id="notification-error" class="text-red-500 text-sm hidden"></div>
        <div class="flex space-x-3 pt-4">
          <button type="button" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-button hover:bg-gray-200" id="cancelNotificationBtn">Annuler</button>
          <button type="button" class="flex-1 px-4 py-2 bg-yellow-500 text-white rounded-button hover:bg-yellow-600" id="requestPermissionBtn">Demander Autorisation</button>
          <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-button hover:bg-primary/90">Envoyer</button>
        </div>
      </form>
    </div>
  `;
  document.body.appendChild(modal);

  const form = modal.querySelector("#notificationForm");
  const cancelBtn = modal.querySelector("#cancelNotificationBtn");
  const requestPermissionBtn = modal.querySelector("#requestPermissionBtn");
  const errorDiv = modal.querySelector("#notification-error");

  cancelBtn.onclick = () => modal.remove();

  requestPermissionBtn.onclick = () => {
    const selectedTypes = form.querySelector("select[name=types]").selectedOptions;
    for (let option of selectedTypes) {
      requestNotificationPermission(option.value);
    }
  };

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    const priority = parseInt(data.priority);
    const selectedTypes = form.querySelector("select[name=types]").selectedOptions;

    try {
      const promises = [];
      for (let option of selectedTypes) {
        const type = option.value;
        const topic = notificationTopics[type];
        promises.push(sendNotification(data.title, data.body, priority, type, topic));
      }
      await Promise.all(promises);
      modal.remove();
      const successModal = document.createElement("div");
      successModal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
      successModal.innerHTML = `
        <div class="bg-white rounded-md p-6 m-4 max-w-sm w-full">
          <div class="text-center">
            <div class="w-12 h-12 rounded-full bg-green-100 mx-auto mb-4 flex items-center justify-center">
              <i class="ri-check-line text-green-500 text-2xl"></i>
            </div>
            <h4 class="text-md font-semibold text-gray-800 mb-2">Notification(s) envoyée(s)</h4>
            <p class="text-gray-600 mb-4">Les notifications ont été envoyées avec succès.</p>
            <button class="w-full bg-primary text-white py-2 rounded-button">Fermer</button>
          </div>
        </div>
      `;
      document.body.appendChild(successModal);
      successModal.querySelector("button").onclick = () => successModal.remove();
    } catch (error) {
      console.error("Erreur lors de l'envoi:", error);
      errorDiv.textContent = `Erreur : ${error.message}`;
      errorDiv.classList.remove("hidden");
    }
  });
}

// Modal pour activer/désactiver les notifications avec switches stylisés
async function showNotificationSettingsModal() {
  await loadPreferences();

  const modal = document.createElement("div");
  modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
  modal.innerHTML = `
    <div class="bg-white rounded-md p-6 m-4 max-w-md w-full">
      <h3 class="text-md font-semibold text-gray-800 mb-4">Paramètres des notifications</h3>
      <div class="space-y-4">
        <label class="flex items-center space-x-3">
          <input type="checkbox" id="liveSwitch" class="toggle-switch" ${userPreferences.Live ? "checked" : ""}>
          <span class="text-sm font-medium text-gray-700">Live</span>
        </label>
        <label class="flex items-center space-x-3">
          <input type="checkbox" id="eventSwitch" class="toggle-switch" ${userPreferences.Événement ? "checked" : ""}>
          <span class="text-sm font-medium text-gray-700">Événement</span>
        </label>
        <label class="flex items-center space-x-3">
          <input type="checkbox" id="newsSwitch" class="toggle-switch" ${userPreferences.News ? "checked" : ""}>
          <span class="text-sm font-medium text-gray-700">News</span>
        </label>
      </div>
      <div class="flex justify-end pt-4">
        <button id="saveSettingsBtn" class="px-4 py-2 bg-primary text-white rounded-button hover:bg-primary/90">Sauvegarder</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  const style = document.createElement("style");
  style.textContent = `
    .toggle-switch {
      width: 50px;
      height: 24px;
      position: relative;
      appearance: none;
      background: #e5e7eb;
      border-radius: 12px;
      outline: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle-switch:checked {
      background: #10b981;
    }
    .toggle-switch::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 2px;
      left: 2px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .toggle-switch:checked::before {
      transform: translateX(26px);
    }
  `;
  document.head.appendChild(style);

  const liveSwitch = modal.querySelector("#liveSwitch");
  const eventSwitch = modal.querySelector("#eventSwitch");
  const newsSwitch = modal.querySelector("#newsSwitch");
  const saveBtn = modal.querySelector("#saveSettingsBtn");

  liveSwitch.checked = userPreferences.Live;
  eventSwitch.checked = userPreferences.Événement;
  newsSwitch.checked = userPreferences.News;

  liveSwitch.addEventListener("change", () => {
    userPreferences.Live = liveSwitch.checked;
    savePreferences();
  });
  eventSwitch.addEventListener("change", () => {
    userPreferences.Événement = eventSwitch.checked;
    savePreferences();
  });
  newsSwitch.addEventListener("change", () => {
    userPreferences.News = newsSwitch.checked;
    savePreferences();
  });

  saveBtn.addEventListener("click", () => {
    savePreferences();
    modal.remove();
    alert("Préférences sauvegardées avec succès !");
  });

  modal.addEventListener("click", (e) => {
    if (e.target === modal) modal.remove();
  });
}

// Écouteurs pour les boutons avec chargement asynchrone
document.getElementById("notification-btn").addEventListener("click", async () => {
  await showNotificationSettingsModal();
});
document.getElementById("send-notification-btn")?.addEventListener("click", showNotificationModal);

// Initialisation du Service Worker et réception des notifications
// if ('serviceWorker' in navigator) {
//   navigator.serviceWorker.register('/sw.js')
//     .then(reg => {
//       console.log('Service Worker enregistré avec succès:', reg.scope);
//       return loadPreferences().then(() => syncPreferencesWithSW());
//     })
//     .catch(error => {
//       console.error('Erreur d\'inscription Service Worker:', error);
//     });
// }

// Fonction utilitaire (non utilisée avec ntfy.sh)
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

// Profile button listener (single listener to avoid conflicts)
document.getElementById("user-btn").addEventListener("click", () => {
  console.log("user-btn clicked, currentUser:", currentUser, "userRole:", userRole); // Debug click
  if (currentUser) {
    showProfileModal();
  } else {
    showLoginModal("login");
  }
});

        function showProfileModal() {
  // Remove existing modals to prevent duplicates
  document.querySelectorAll(".fixed.inset-0").forEach(modal => modal.remove());
  const modal = document.createElement("div");
  modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
  modal.innerHTML = `
    <div class="bg-white rounded-md p-6 m-4 max-w-sm w-full">
      <h4 class="font-bold text-md mb-4">Profil</h4>
      <div class="flex items-center space-x-3 mb-4">
        <img src="${currentUser.avatar || 'https://cine-production.github.io/ServiceTiers/BASEDONNEE/CP/images/avatar/avatar1.png'}" 
             class="w-12 h-12 rounded-full" 
             alt="Avatar de l'utilisateur">
        <div>
          <p class="text-gray-600 font-medium">${currentUser.email}</p>
          <p class="text-gray-500 text-sm">${userRole === 'admin' ? 'Administrateur' : 'Utilisateur'}</p>
        </div>
      </div>
      <button id="logout-btn" class="w-full bg-red-500 text-white py-2 rounded-button mt-4">Se déconnecter</button>
      <button id="delete-account-btn" class="w-full bg-gray-600 text-white py-2 rounded-button mt-2">Supprimer le compte</button>
      <button id="cancel-user-btn" class="w-full bg-gray-100 text-gray-700 py-2 rounded-button mt-2">Fermer</button>
    </div>`;
  document.body.appendChild(modal);
  console.log("Profile modal appended:", modal);

  modal.querySelector("#logout-btn").onclick = async () => {
    try {
      await signOut(auth);
      modal.remove();
      alert("Déconnexion réussie.");
      loadHomePage();
    } catch (error) {
      alert("Erreur lors de la déconnexion : " + error.message);
    }
  };

  modal.querySelector("#delete-account-btn").onclick = async () => {
    if (!confirm("Êtes-vous sûr de vouloir supprimer votre compte ? Cette action est irréversible et supprimera toutes vos données associées.")) {
      return;
    }

    try {
      // Supprimer les données utilisateur dans Firestore
      const userDocRef = doc(db, "users", currentUser.uid);
      await deleteDoc(userDocRef);
      console.log("Données utilisateur supprimées de Firestore");

      // Tenter de supprimer le compte Firebase Authentication
      try {
        await deleteUser(auth.currentUser);
        console.log("Compte Firebase Authentication supprimé");
      } catch (authError) {
        console.warn("Erreur lors de la suppression du compte Authentication :", authError);
        if (authError.code === "auth/requires-recent-login") {
          // Ignorer l'erreur de reconnexion et continuer
          console.log("Suppression du compte Authentication ignorée en raison de la nécessité d'une reconnexion récente.");
        } else {
          throw authError; // Relancer les autres erreurs
        }
      }

      // Fermer le modal et recharger la page d'accueil
      modal.remove();
      alert("Votre compte et vos données ont été supprimés avec succès.");
      loadHomePage();
    } catch (error) {
      console.error("Erreur lors de la suppression du compte :", error);
      alert("Erreur lors de la suppression du compte : " + error.message);
    }
  };

  modal.querySelector("#cancel-user-btn").onclick = () => modal.remove();
}

        function showLoginModal(mode = "login") {
          // Remove existing modals
          document.querySelectorAll(".fixed.inset-0").forEach(modal => modal.remove());
          const modal = document.createElement("div");
          modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
          document.body.appendChild(modal);

          function renderLogin() {
            modal.innerHTML = `
              <div class="bg-white rounded-md p-6 m-4 max-w-sm w-full">
                <h4 class="font-bold text-md mb-4">Connexion</h4>
                <form id="loginForm" method="post" class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" name="email" required class="w-full px-3 py-2 border rounded-button">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                    <input type="password" name="password" required class="w-full px-3 py-2 border rounded-button">
                  </div>
                  <div id="login-error" class="text-red-500 text-sm hidden"></div>
                  <div class="flex space-x-3 pt-4">
                    <button type="button" id="switch-to-signup" class="flex-1 bg-gray-100 rounded-button">S'inscrire</button>
                    <button type="submit" class="flex-1 bg-primary text-white rounded-button">Se connecter</button>
                  </div>
                  <button type="button" id="cancelLogin" class="w-full mt-2 bg-gray-100 rounded-button">Annuler</button>
                </form>
              </div>`;

            // Ensure form exists before attaching listeners
            const form = modal.querySelector("#loginForm");
            if (!form) {
              console.error("Login form not found in modal");
              return;
            }

            form.onsubmit = async e => {
              e.preventDefault();
              const { email, password } = Object.fromEntries(new FormData(e.target));
              console.log("Login attempt with email:", email); // Debug login attempt
              try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("Login successful, user:", userCredential.user); // Debug success
                modal.remove();
                alert("Connexion réussie !");
                loadHomePage();
              } catch (error) {
                console.error("Login error:", error.code, error.message); // Debug error
                const errorDiv = modal.querySelector("#login-error");
                if (errorDiv) {
                  errorDiv.textContent = error.code === "auth/user-not-found" || error.code === "auth/wrong-password"
                    ? "Identifiants incorrects."
                    : error.message;
                  errorDiv.classList.remove("hidden");
                }
              }
            };

            const switchToSignupBtn = modal.querySelector("#switch-to-signup");
            const cancelLoginBtn = modal.querySelector("#cancelLogin");
            if (switchToSignupBtn) switchToSignupBtn.onclick = renderSignup;
            if (cancelLoginBtn) cancelLoginBtn.onclick = () => modal.remove();
          }

          function renderSignup() {
  modal.innerHTML = `
    <div class="bg-white rounded-md p-6 m-4 max-w-sm w-full">
      <h4 class="font-bold text-md mb-4">Inscription</h4>
      <form id="signupForm" method="post" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input type="email" name="email" required class="w-full px-3 py-2 border rounded-button">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
          <input type="password" name="password" required class="w-full px-3 py-2 border rounded-button">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Pseudonyme</label>
          <input type="text" name="pseudo" required class="w-full px-3 py-2 border rounded-button">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Avatar</label>
          <div class="relative">
            <button type="button" id="select-avatar-btn" class="w-full px-3 py-2 border border-gray-300 rounded-button bg-white text-left text-gray-500 flex items-center justify-between">
              <span id="avatar-placeholder">Sélectionner un avatar</span>
              <i class="ri-arrow-down-s-line"></i>
            </button>
            <input type="hidden" name="avatar" id="avatar-input">
            <img id="avatar-preview" class="hidden w-12 h-12 rounded-full mt-2" alt="Aperçu de l'avatar">
          </div>
        </div>
        <div id="signup-error" class="text-red-500 text-sm hidden"></div>
        <div class="flex space-x-3 pt-4">
          <button type="button" id="switch-to-login" class="flex-1 bg-gray-100 rounded-button">Se connecter</button>
          <button type="submit" class="flex-1 bg-primary text-white rounded-button">S'inscrire</button>
        </div>
        <button type="button" id="cancelSignup" class="w-full mt-2 bg-gray-100 rounded-button">Annuler</button>
      </form>
    </div>`;

  const form = modal.querySelector("#signupForm");
  if (!form) {
    console.error("Formulaire d'inscription non trouvé dans le modal");
    return;
  }

  // Ajouter le modal pour la sélection des avatars
  const avatarModal = document.createElement("div");
  avatarModal.id = "avatar-selection-modal";
  avatarModal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden";
  avatarModal.innerHTML = `
    <div class="bg-white rounded-md p-6 m-4 max-w-md w-full">
      <h3 class="text-md font-semibold mb-4">Choisir un avatar</h3>
      <div id="avatar-grid" class="grid grid-cols-4 gap-4 mb-4">
        ${[...Array(12)].map((_, i) => `
          <img src="https://cine-production.github.io/ServiceTiers/BASEDONNEE/CP/images/avatar/avatar${i+1}.png" 
               class="w-12 h-12 rounded-full cursor-pointer hover:ring-2 hover:ring-primary avatar-option" 
               data-url="https://cine-production.github.io/ServiceTiers/BASEDONNEE/CP/images/avatar/avatar${i+1}.png"
               alt="Avatar ${i+1}">
        `).join('')}
      </div>
      <button id="close-avatar-modal" class="w-full bg-primary text-white py-2 rounded-button">Fermer</button>
    </div>
  `;
  document.body.appendChild(avatarModal);

  // Gestion du bouton de sélection d'avatar
  const selectAvatarBtn = modal.querySelector("#select-avatar-btn");
  const avatarInput = modal.querySelector("#avatar-input");
  const avatarPreview = modal.querySelector("#avatar-preview");
  const avatarPlaceholder = modal.querySelector("#avatar-placeholder");
  const closeAvatarModal = avatarModal.querySelector("#close-avatar-modal");
  const avatarOptions = avatarModal.querySelectorAll(".avatar-option");

  selectAvatarBtn.onclick = () => {
    avatarModal.classList.remove("hidden");
  };

  closeAvatarModal.onclick = () => {
    avatarModal.classList.add("hidden");
  };

  avatarOptions.forEach(option => {
    option.addEventListener("click", () => {
      const url = option.dataset.url;
      avatarInput.value = url;
      avatarPreview.src = url;
      avatarPreview.classList.remove("hidden");
      avatarPlaceholder.textContent = "Avatar sélectionné";
      avatarModal.classList.add("hidden");
    });
  });

  form.onsubmit = async e => {
    e.preventDefault();
    const { email, password, pseudo, avatar } = Object.fromEntries(new FormData(e.target));
    if (!avatar) {
      const errorDiv = modal.querySelector("#signup-error");
      errorDiv.textContent = "Veuillez sélectionner un avatar.";
      errorDiv.classList.remove("hidden");
      return;
    }
    try {
      const uc = await createUserWithEmailAndPassword(auth, email, password);
      await setDoc(doc(db, "users", uc.user.uid), {
        uid: uc.user.uid,
        email,
        pseudo,
        avatar,
        role: "user",
        createdAt: serverTimestamp()
      });
      modal.remove();
      avatarModal.remove();
      alert("Inscription réussie !");
      loadHomePage();
    } catch (err) {
      console.error("Erreur d'inscription :", err.code, err.message);
      const errorDiv = modal.querySelector("#signup-error");
      if (errorDiv) {
        errorDiv.textContent = err.code === "auth/email-already-in-use" ? "Email déjà utilisé." : err.message;
        errorDiv.classList.remove("hidden");
      }
    }
  };

  const switchToLoginBtn = modal.querySelector("#switch-to-login");
  const cancelSignupBtn = modal.querySelector("#cancelSignup");
  if (switchToLoginBtn) switchToLoginBtn.onclick = () => {
    avatarModal.remove();
    renderLogin();
  };
  if (cancelSignupBtn) cancelSignupBtn.onclick = () => {
    modal.remove();
    avatarModal.remove();
  };
}

          mode === "signup" ? renderSignup() : renderLogin();
        }

        // Navigation
        const navItems = document.querySelectorAll(".nav-item");
        const pages = document.querySelectorAll(".page-content");

        function showPage(pageId) {
  pages.forEach(page => page.classList.add("hidden"));
  document.getElementById(pageId).classList.remove("hidden");

  navItems.forEach(item => {
    item.classList.remove("text-primary");
    item.classList.remove("active-tab");
    item.style.cssText = 'fill: rgb(107 114 128 / var(--tw-text-opacity, 1));';
    item.classList.add("text-gray-500");
    item.classList.add("inactive-tab");
    const icon = item.querySelector("i");
    if (icon) {
      icon.classList.remove("ri-home-4-fill", "ri-calendar-2-fill", "ri-star-smile-fill", "ri-links-fill", "ri-restroom-fill");
      icon.classList.add(
        item.getAttribute("data-page") === "home-page" ? "ri-home-4-line" :
        item.getAttribute("data-page") === "calendar-page" ? "ri-calendar-2-line" :
        item.getAttribute("data-page") === "ratings-page" ? "ri-star-smile-line" :
        item.getAttribute("data-page") === "more-page" ? "ri-links-line" :
        item.getAttribute("data-page") === "toilets-page" ? "ri-restroom-line" :
        ""
      );
    }
  });
  const activeItem = document.querySelector(`[data-page="${pageId}"]`);
  activeItem.classList.remove("text-gray-500");
  activeItem.classList.remove("inactive-tab");
  activeItem.style.cssText = 'fill: var(--white-color) !important;';
  activeItem.classList.add("text-primary");
  activeItem.classList.add("active-tab");
  const activeIcon = activeItem.querySelector("i");
  if (activeIcon) {
    activeIcon.classList.remove("ri-home-4-line", "ri-calendar-2-line", "ri-star-smile-line", "ri-links-line", "ri-restroom-line");
    activeIcon.classList.add(
      pageId === "home-page" ? "ri-home-4-fill" :
      pageId === "calendar-page" ? "ri-calendar-2-fill" :
      pageId === "ratings-page" ? "ri-star-smile-fill" :
      pageId === "more-page" ? "ri-links-fill" :
      pageId === "toilets-page" ? "ri-restroom-fill" :
      ""
    );
  }
}

        navItems.forEach(item => {
          item.addEventListener("click", function (e) {
            e.preventDefault();
            const pageId = this.getAttribute("data-page");
            showPage(pageId);
          });
        });

        // Initialize to home page
        showPage("home-page");

        // Load Home Page
        async function loadHomePage() {
          const liveEvents = document.getElementById("live-events");
          const newsSection = document.getElementById("news-section");
          const isAdmin = userRole === "admin";

          // Affiche ou masque le bouton "Définir en LIVE"
          document.getElementById("set-live-admin-container").classList.toggle("hidden", !isAdmin);

          // CHARGER LE STATUT EN LIVE
          try {
            const statusDoc = await getDoc(doc(db, "status", "liveStatus"));
            const bannerContainer = document.getElementById("live-banner-container");
            if (statusDoc.exists() && statusDoc.data().active && statusDoc.data().url) {
              bannerContainer.classList.remove("hidden");
              document.getElementById("live-banner-link").href = statusDoc.data().url;
              if (isAdmin) {
                document.getElementById("edit-live-banner").classList.remove("hidden");
                document.getElementById("stop-live-banner").classList.remove("hidden");
              }
            } else {
              bannerContainer.classList.add("hidden");
            }
          } catch (err) {
            console.error("Erreur chargement statut live :", err);
          }

          // MODIFIER LE LIVE
          document.getElementById("edit-live-banner").addEventListener("click", async () => {
            const statusRef = doc(db, "status", "liveStatus");
            const snap = await getDoc(statusRef);
            const currentUrl = snap.exists() ? snap.data().url : "";

            const modal = document.createElement("div");
            modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
            modal.innerHTML = `
              <div class="bg-white rounded-md p-6 m-4 max-w-sm w-full">
                <h3 class="text-lg font-semibold mb-4">Modifier l'URL du live</h3>
                <form id="editLiveForm" class="space-y-4">
                  <input type="url" name="url" required placeholder="https://..." value="${currentUrl}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
                  <div class="flex space-x-2">
                    <button type="button" class="w-full py-2 bg-gray-100 text-gray-700 rounded-button" id="cancelEditLive">Annuler</button>
                    <button type="submit" class="w-full py-2 bg-primary text-white rounded-button">Mettre à jour</button>
                  </div>
                </form>
              </div>
            `;
            document.body.appendChild(modal);

            document.getElementById("cancelEditLive").onclick = () => modal.remove();

            document.getElementById("editLiveForm").onsubmit = async (e) => {
              e.preventDefault();
              const url = e.target.url.value;
              try {
                await setDoc(statusRef, {
                  active: true,
                  url,
                  updatedAt: serverTimestamp()
                });
                modal.remove();
                loadHomePage();
              } catch (err) {
                alert("Erreur : " + err.message);
              }
            };
          });

          // CHARGER LES DERNIERS LIVES
          liveEvents.innerHTML = '<p class="text-gray-600">Chargement...</p>';
          try {
            const q = query(collection(db, "lastLive"), orderBy("date", "desc"), limit(5));
            const snapshot = await getDocs(q);
            liveEvents.innerHTML = snapshot.empty
              ? '<p class="text-gray-600">Aucun live disponible</p>'
              : '';

            snapshot.forEach(doc => {
              const event = doc.data();
              if (event.type !== "Live") return;
              const date = event.date.toDate();

              const card = document.createElement("div");
              card.className = "min-w-[160px] max-w-[160px] bg-white rounded-lg shadow-sm p-2 flex-shrink-0";

              card.innerHTML = `
                <div class="aspect-video mb-2">
                  <iframe class="w-full h-full rounded-md" src="${convertToEmbedUrl(event.youtubeUrl)}" frameborder="0" allowfullscreen></iframe>
                </div>
                <h3 class="text-xs font-semibold text-gray-800 truncate">${event.title || 'Sans titre'}</h3>
                <p class="text-[10px] text-gray-500">${date.toLocaleDateString('fr-FR')}</p>
              `;

              liveEvents.appendChild(card);
            });
          } catch (error) {
            console.error("Erreur chargement des lives :", error);
            liveEvents.innerHTML = '<p class="text-red-500">Erreur de chargement</p>';
          }

          // CHARGER LES ACTUALITÉS
          try {
            const qNews = query(collection(db, "news"), orderBy("createdAt", "desc"), limit(10));
            const snapshotNews = await getDocs(qNews);
            newsSection.innerHTML = snapshotNews.empty
              ? '<p class="text-gray-600">Aucune actualité pour le moment.</p>'
              : '';

            snapshotNews.forEach(doc => {
              const news = doc.data();
              newsSection.innerHTML += `
                <div class="bg-white rounded-md p-4 shadow-sm">
                  <div class="flex justify-between items-start">
                    <div>
                      <h3 class="text-lg font-semibold text-gray-800">${news.title || 'Sans titre'}</h3>
                      <p class="text-sm text-gray-600 mt-1">${news.description || ''}</p>
                    </div>
                    ${isAdmin ? `
                      <div class="flex space-x-2">
                        <button class="edit-news text-blue-500 text-sm font-medium cursor-pointer" data-id="${doc.id}">Modifier</button>
                        <button class="delete-news text-red-500 text-sm font-medium cursor-pointer" data-id="${doc.id}">Supprimer</button>
                      </div>
                    ` : ''}
                  </div>
                  ${news.videoUrl ? `
                    <div class="aspect-video mt-3">
                      <iframe class="w-full h-full rounded-md" src="${convertToEmbedUrl(news.videoUrl)}" frameborder="0" allowfullscreen></iframe>
                    </div>
                  ` : ''}
                </div>
              `;
            });

            // Event handlers pour actus
            document.querySelectorAll(".delete-news").forEach(btn => {
              btn.addEventListener("click", async () => {
                if (confirm("Supprimer cette actualité ?")) {
                  await deleteDoc(doc(db, "news", btn.dataset.id));
                  loadHomePage();
                }
              });
            });

            document.querySelectorAll(".edit-news").forEach(btn => {
              btn.addEventListener("click", async () => {
                const ref = doc(db, "news", btn.dataset.id);
                const snap = await getDoc(ref);
                if (!snap.exists()) return;
                const data = snap.data();
                showNewsModal({ ...data, id: btn.dataset.id });
              });
            });
          } catch (error) {
            console.error("Erreur actualités :", error);
            newsSection.innerHTML = '<p class="text-red-500">Erreur de chargement</p>';
          }
        }

        function showNewsModal(news) {
          const modal = document.createElement("div");
          modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
          modal.innerHTML = `
            <div class="bg-white rounded-md p-6 m-4 max-w-md w-full">
              <form id="newsForm" class="space-y-4">
                <h3 class="text-md font-semibold text-gray-800 mb-4">${news.id ? "Modifier" : "Ajouter"} une actualité</h3>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Titre</label>
                  <input type="text" name="title" required value="${news.title || ''}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                  <textarea name="description" rows="3" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">${news.description || ''}</textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">URL Vidéo (optionnelle)</label>
                  <input type="url" name="videoUrl" value="${news.videoUrl || ''}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="flex space-x-3 pt-4">
                  <button type="button" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-button hover:bg-gray-200" id="cancelNewsBtn">Annuler</button>
                  <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-button hover:bg-primary/90">Valider</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(modal);

          document.getElementById("cancelNewsBtn").onclick = () => modal.remove();

          document.getElementById("newsForm").onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            try {
              await setDoc(doc(db, "news", news.id || doc(collection(db, "news")).id), {
                title: data.title,
                description: data.description,
                videoUrl: data.videoUrl || null,
                createdAt: news.createdAt || serverTimestamp(),
                updatedAt: serverTimestamp(),
                createdBy: currentUser.uid
              });
              modal.remove();
              loadHomePage();
            } catch (err) {
              alert("Erreur lors de la mise à jour : " + err.message);
            }
          };
        }

        document.getElementById("add-news-btn").addEventListener("click", () => {
          showNewsModal({});
        });

        document.getElementById("set-live-btn").addEventListener("click", () => {
          const modal = document.createElement("div");
          modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
          modal.innerHTML = `
            <div class="bg-white rounded-md p-6 m-4 max-w-sm w-full">
              <h3 class="text-lg font-semibold mb-4">Démarrer un LIVE</h3>
              <form id="liveStatusForm" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Titre du live</label>
                  <input type="text" name="title" required placeholder="Nom du live"
                    class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">URL du live</label>
                  <input type="url" name="url" required placeholder="https://..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="flex space-x-2">
                  <button type="button" id="cancelLiveStatus" class="w-full py-2 bg-gray-100 text-gray-700 rounded-button">Annuler</button>
                  <button type="submit" class="w-full py-2 bg-primary text-white rounded-button">Démarrer</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(modal);

          document.getElementById("cancelLiveStatus").onclick = () => modal.remove();

          document.getElementById("liveStatusForm").onsubmit = async e => {
            e.preventDefault();
            const form = e.target;
            const title = form.title.value;
            const url = form.url.value;
            try {
              await setDoc(doc(db, "status", "liveStatus"), {
                active: true,
                url,
                title,
                updatedAt: serverTimestamp(),
                createdBy: currentUser.uid
              });
              modal.remove();
              loadHomePage();
            } catch (err) {
              alert("Erreur : " + err.message);
            }
          };
        });

        let stopLiveInProgress = false;

        document.getElementById("stop-live-banner").addEventListener("click", async () => {
  if (stopLiveInProgress) return;
  if (!confirm("Arrêter ce live et l’enregistrer ?")) return;

  stopLiveInProgress = true;

  try {
    const liveRef = doc(db, "status", "liveStatus");
    const liveSnap = await getDoc(liveRef);

    if (liveSnap.exists() && liveSnap.data().active) {
      const liveData = liveSnap.data();

      await addDoc(collection(db, "lastLive"), {
        title: liveData.title || "Live sans titre",
        youtubeUrl: liveData.url || null,
        type: "Live",
        date: new Date(),
        createdBy: liveData.createdBy || currentUser?.uid || "unknown"
      });

      await setDoc(liveRef, {
        active: false,
        url: null,
        title: null,
        updatedAt: serverTimestamp()
      });

      loadHomePage();
    }
  } catch (err) {
    alert("Erreur lors de l'arrêt du LIVE : " + err.message);
  } finally {
    stopLiveInProgress = false;
  }
});


        // Load Calendar
        async function loadCalendar(filter = "all") {
  const calendarGrid = document.getElementById("calendar-grid");
  const eventList = document.getElementById("event-list");
  const upcomingEvents = document.getElementById("upcoming-events");
  const monthDisplay = document.getElementById("month-display");
  const eventsTitle = document.getElementById("events-title");

  // Update month display
  monthDisplay.textContent = currentMonth.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
  eventsTitle.textContent = `Événements du ${selectedDay} ${currentMonth.toLocaleString('fr-FR', { month: 'long' })}`;

  // Generate calendar
  const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
  const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
  const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Lundi = 0, Dimanche = 6

  console.log("Calendar debug:", {
    currentMonth: currentMonth.toISOString(),
    firstDay: firstDay.toISOString(),
    lastDay: lastDay.toISOString(),
    startDay: startDay,
    totalDays: lastDay.getDate()
  });

  calendarGrid.innerHTML = '';

  // Previous month days
  const prevMonthLastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 0).getDate();
  for (let i = startDay - 1; i >= 0; i--) {
    calendarGrid.innerHTML += `
      <div class="aspect-square flex flex-col items-center justify-start p-1 bg-gray-100 rounded opacity-50">
        <span class="text-xs">${prevMonthLastDay - i}</span>
      </div>
    `;
  }

  // Current month days
  try {
    // Requête Firestore pour récupérer les événements qui chevauchent le mois courant
    const q = query(
      collection(db, "events"),
      where("date", "<=", new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0))
    );
    const snapshot = await getDocs(q);

    const eventsByDay = {};
    const singleDayEvents = {};

    // Traiter les événements
    snapshot.forEach(doc => {
      const event = doc.data();
      const startDate = event.date && event.date.toDate ? event.date.toDate() : null;
      const endDate = event.endDate && event.endDate.toDate ? event.endDate.toDate() : startDate;
      if (!startDate) {
        console.warn("Invalid event date:", doc.id, event);
        return;
      }

      const eventMonth = startDate.getMonth();
      const eventYear = startDate.getFullYear();
      const endMonth = endDate ? endDate.getMonth() : eventMonth;
      const endYear = endDate ? endDate.getFullYear() : eventYear;

      // Vérifier si l'événement chevauchent le mois courant
      const monthStart = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
      const monthEnd = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
      if (startDate <= monthEnd && (!endDate || endDate >= monthStart)) {
        const startDayInMonth = (eventMonth === currentMonth.getMonth() && eventYear === currentMonth.getFullYear())
          ? startDate.getDate()
          : 1;
        const endDayInMonth = endDate && endMonth === currentMonth.getMonth() && endYear === currentMonth.getFullYear()
          ? endDate.getDate()
          : (endMonth > currentMonth.getMonth() || endYear > currentMonth.getFullYear())
            ? lastDay.getDate()
            : startDayInMonth;

        // Ajouter l'événement à chaque jour concerné
        for (let day = startDayInMonth; day <= endDayInMonth; day++) {
          if (!eventsByDay[day]) eventsByDay[day] = [];
          eventsByDay[day].push({
            id: doc.id,
            ...event,
            startDayInMonth,
            endDayInMonth,
            isMultiDay: endDayInMonth !== startDayInMonth || eventMonth !== endMonth || eventYear !== endYear
          });
        }

        // Ajouter les événements d'un seul jour
        if (endDayInMonth === startDayInMonth && eventMonth === endMonth && eventYear === endYear) {
          if (!singleDayEvents[startDayInMonth]) singleDayEvents[startDayInMonth] = [];
          singleDayEvents[startDayInMonth].push({ id: doc.id, type: event.type });
        }
      }
    });

    console.log("Events loaded:", { eventsByDay, singleDayEvents });

    // Rendre les jours du mois courant
    for (let day = 1; day <= lastDay.getDate(); day++) {
      const hasEvents = eventsByDay[day] && eventsByDay[day].length > 0;
      const isSelected = day === selectedDay;
      const hasSingleDayEvents = singleDayEvents[day] && singleDayEvents[day].length > 0;
      const multiDayEventsOnDay = eventsByDay[day]
        ? eventsByDay[day].filter(e => e.isMultiDay).map((e, index) => ({
            ...e,
            index // Ajouter un index pour gérer la superposition
          }))
        : [];

      calendarGrid.innerHTML += `
        <div class="aspect-square flex flex-col items-center justify-start p-1 ${isSelected ? 'bg-primary text-white' : 'bg-white'} rounded shadow-sm ${hasEvents ? 'cursor-pointer' : ''} relative multi-day-part"
             data-day="${day}">
          <span class="text-xs ${isSelected ? 'font-bold text-white' : ''}">${day}</span>
          <div class="event-markers flex flex-row items-center justify-center gap-1 mt-1">
            ${hasSingleDayEvents ? singleDayEvents[day].map((event) => `
              <div class="event-dot w-2 h-2 bg-${event.type === 'Live' ? 'blue' : event.type === 'Visite' ? 'amber' : event.type === 'Food' ? 'red' : 'purple'}-500 rounded-full"></div>
            `).join('') : ''}
          </div>
          <div class="multi-day-markers flex flex-col items-center gap-1">
            ${multiDayEventsOnDay.map(event => {
              const isWithinRange = day >= event.startDayInMonth && day <= event.endDayInMonth;
              return isWithinRange ? `
                <div class="multi-day-bar ${event.type === 'Live' ? 'bg-blue-500' : event.type === 'Visite' ? 'bg-amber-500' : event.type === 'Food' ? 'bg-red-500' : 'bg-purple-500'}"
                     style="width: 100%; left: 0; position: absolute; bottom: ${4 + event.index * 8}px; height: 3px;"></div>
              ` : '';
            }).join('')}
          </div>
        </div>
      `;
    }

    // Remplir les jours du mois suivant pour compléter la grille
    const totalCells = startDay + lastDay.getDate();
    const nextMonthDays = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (let i = 1; i <= nextMonthDays; i++) {
      calendarGrid.innerHTML += `
        <div class="aspect-square flex flex-col items-center justify-start p-1 bg-gray-100 rounded opacity-50">
          <span class="text-xs">${i}</span>
        </div>
      `;
    }

    // Load events for selected day
    const isAdmin = userRole === "admin";
    const filteredEvents = filter === "all" ? (eventsByDay[selectedDay] || []) : (eventsByDay[selectedDay] || []).filter(e => e.type === filter);
    eventList.innerHTML = filteredEvents.length === 0 ? '<p class="text-gray-600">Aucun événement pour ce jour.</p>' : '';

    filteredEvents.forEach(event => {
      const startDate = event.date && event.date.toDate ? event.date.toDate() : new Date();
      const endDate = event.endDate && event.endDate.toDate ? event.endDate.toDate() : null;
      const dateDisplay = endDate && endDate.getDate() !== startDate.getDate()
        ? `${startDate.toLocaleDateString('fr-FR')} - ${endDate.toLocaleDateString('fr-FR')}`
        : startDate.toLocaleDateString('fr-FR');
      const borderColor = {
        Live: 'border-blue-500',
        Visite: 'border-amber-500',
        Food: 'border-red-500',
        Nocturne: 'border-purple-500'
      }[event.type] || 'border-gray-300';
      const tagColor = {
        Live: 'bg-blue-100 text-blue-500',
        Visite: 'bg-amber-100 text-amber-600',
        Food: 'bg-red-100 text-red-500',
        Nocturne: 'bg-purple-100 text-purple-500'
      }[event.type] || 'bg-gray-100 text-gray-500';

      eventList.innerHTML += `
        <div class="bg-white rounded-md p-4 shadow-sm border-l-4 ${borderColor}" data-event-id="${event.id}">
          <div class="flex justify-between items-start">
            <div>
              <h4 class="font-semibold text-gray-800">${event.title || 'Sans titre'}</h4>
              <p class="text-sm text-gray-600 mt-1">${dateDisplay} ${event.startTime || 'N/A'} - ${event.endTime || 'N/A'}</p>
            </div>
            <div class="flex space-x-2">
              <span class="px-2 py-1 ${tagColor} text-xs rounded-full">${event.type || 'N/A'}</span>
              ${isAdmin ? `
                <button class="edit-event text-blue-600 text-sm font-medium cursor-pointer" data-event-id="${event.id}">Modifier</button>
                <button class="delete-event text-red-600 text-sm font-medium cursor-pointer" data-event-id="${event.id}">Supprimer</button>
              ` : ''}
            </div>
          </div>
          <p class="text-sm text-gray-700 mt-2">${event.description || 'Aucune description'}</p>
          <div class="flex justify-between items-center mt-3">
            <div class="flex items-center space-x-2">
              <div class="w-6 h-6 flex items-center justify-center text-gray-500">
                <i class="ri-map-pin-line"></i>
              </div>
              <span class="text-xs text-gray-600">${event.location || 'Lieu non spécifié'}</span>
            </div>
            <button class="text-blue-500 text-sm font-medium cursor-pointer" data-event-id="${event.id}">Détails</button>
          </div>
        </div>
      `;
    });

    // Load upcoming events
    const now = new Date();
    const upcomingQ = query(collection(db, "events"), where("date", ">", now), orderBy("date"), limit(5));
    const upcomingSnapshot = await getDocs(upcomingQ);

    upcomingEvents.innerHTML = upcomingSnapshot.empty ? '<p class="text-gray-600">Aucun événement à venir</p>' : '';

    upcomingSnapshot.forEach(doc => {
      const event = doc.data();
      const startDate = event.date && event.date.toDate ? event.date.toDate() : new Date();
      const endDate = event.endDate && typeof event.endDate === 'object' && event.endDate.toDate ? event.endDate.toDate() : startDate;
      const dateDisplay = endDate && endDate.getDate() !== startDate.getDate()
        ? `${startDate.toLocaleDateString('fr-FR')} - ${endDate.toLocaleDateString('fr-FR')}`
        : startDate.toLocaleDateString('fr-FR');
      const tagColor = {
        Live: 'bg-blue-100 text-blue-500',
        Visite: 'bg-amber-100 text-purple-500',
        Food: 'bg-red-100 text-red-500',
        Nocturne: 'bg-purple-100 text-purple-500'
      }[event.type] || 'bg-gray-100 text-gray-500';

      upcomingEvents.innerHTML += `
        <div class="bg-white rounded-md p-4 shadow-sm" data-type="${event.type || 'N/A'}">
          <div class="flex items-center">
            <div class="flex-shrink-0 w-12 text-center">
              <span class="block text-sm font-semibold text-gray-800">${startDate.getDate()}</span>
              <span class="block text-xs text-gray-500">${startDate.toLocaleString('fr-FR', { month: 'short' })}</span>
            </div>
            <div class="ml-4">
              <h4 class="font-medium text-gray-800">${event.title || 'Sans titre'}</h4>
              <div class="flex items-center mt-1">
                <div class="w-4 h-4 flex items-center justify-center text-${event.type === 'Live' ? 'blue' : event.type === 'Visite' ? 'amber' : event.type === 'Food' ? 'red' : 'purple'}-500">
                  <i class="ri-time-line"></i>
                </div>
                <span class="text-xs text-gray-600 ml-1">${dateDisplay} ${event.startTime || 'N/A'} - ${event.endTime || 'N/A'}</span>
              </div>
            </div>
            <div class="ml-auto flex space-x-2">
              <span class="px-2 py-1 ${tagColor} text-xs rounded-full">${event.type || 'N/A'}</span>
              ${isAdmin ? `
                <button class="edit-event text-blue-600 text-sm font-medium cursor-pointer" data-event-id="${doc.id}">Modifier</button>
                <button class="delete-event text-red-600 text-sm font-medium cursor-pointer" data-event-id="${doc.id}">Supprimer</button>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    });

    // Event listeners for calendar days
    const calendarDays = calendarGrid.querySelectorAll("[data-day]");
    calendarDays.forEach(day => {
      day.addEventListener("click", function () {
        selectedDay = parseInt(this.getAttribute("data-day"));
        calendarDays.forEach(d => {
          d.classList.remove("bg-primary", "text-white");
          d.classList.add("bg-white");
          const span = d.querySelector("span");
          if (span) span.classList.remove("text-white", "font-bold");
        });
        this.classList.add("bg-primary", "text-white");
        this.querySelector("span").classList.add("text-white", "font-bold");
        eventsTitle.textContent = `Événements du ${selectedDay} ${currentMonth.toLocaleString('fr-FR', { month: 'long' })}`;
        loadCalendar(filter);
      });
    });

    // Event listeners for detail buttons
    const detailButtons = document.querySelectorAll("button[data-event-id]");
    detailButtons.forEach(button => {
      button.addEventListener("click", async function () {
        const eventId = this.getAttribute("data-event-id");
        const docRef = doc(db, "events", eventId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const event = docSnap.data();
          const startDate = event.date && event.date.toDate ? event.date.toDate() : new Date();
          const endDate = event.endDate && typeof event.endDate === 'object' && event.endDate.toDate ? event.endDate.toDate() : null;
          const dateDisplay = endDate && endDate.getDate() !== startDate.getDate()
            ? `${startDate.toLocaleDateString('fr-FR')} - ${endDate.toLocaleDateString('fr-FR')}`
            : startDate.toLocaleDateString('fr-FR');
          const eventDialog = document.createElement("div");
          eventDialog.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
          eventDialog.innerHTML = `
            <div class="bg-white rounded-md p-6 m-4 max-w-sm w-full">
              <h4 class="font-bold text-md mb-4">${event.title || 'Sans titre'}</h4>
              <p class="text-gray-600 mb-2">${dateDisplay} ${event.startTime || 'N/A'} - ${event.endTime || 'N/A'}</p>
              <p class="text-gray-600 mb-2">${event.location || 'Lieu non spécifié'}</p>
              <p class="text-gray-600 mb-4">${event.description || 'Aucune description'}</p>
              <button class="w-full bg-blue-500 text-white py-2 rounded">Fermer</button>
            </div>
          `;
          document.body.appendChild(eventDialog);
          eventDialog.querySelector("button").onclick = () => eventDialog.remove();
        } else {
          console.error("Event not found:", eventId);
        }
      });
    });

    // Event listeners for edit and delete buttons
    document.querySelectorAll(".edit-event").forEach(button => {
      button.addEventListener("click", () => editEvent(button.getAttribute("data-event-id")));
    });
    document.querySelectorAll(".delete-event").forEach(button => {
      button.addEventListener("click", () => deleteEvent(button.getAttribute("data-event-id")));
    });
  } catch (error) {
    console.error("Error loading calendar:", error);
    eventList.innerHTML = '<p class="text-red-500">Erreur de chargement</p>';
  }
}

        // Load Ratings
        async function loadRatings() {
  const ratingsList = document.getElementById("ratings-list");
  if (!ratingsList) {
    console.error("Élément ratings-list non trouvé dans le DOM");
    return;
  }
  ratingsList.innerHTML = '<p class="text-gray-600">Chargement...</p>';

  try {
    const q = query(collection(db, "ratings"), orderBy("createdAt", "desc"), limit(10));
    const snapshot = await getDocs(q);

    ratingsList.innerHTML = snapshot.empty ? '<p class="text-gray-600">Aucune évaluation disponible</p>' : '';

    snapshot.forEach(doc => {
      const rating = doc.data();
      const date = rating.createdAt && rating.createdAt.toDate ? rating.createdAt.toDate() : new Date();
      const isAdmin = typeof userRole !== 'undefined' && userRole === "admin"; // Vérification explicite

      ratingsList.innerHTML += `
        <div class="bg-white rounded-md p-4 shadow-sm" data-rating-id="${doc.id}">
          <div class="flex justify-between items-start">
            <div>
              <h4 class="font-semibold text-gray-800">${rating.eventTitle || 'Sans titre'}</h4>
              <p class="text-sm text-gray-600 mt-1">${date.toLocaleDateString('fr-FR')}</p>
            </div>
            <div class="flex items-center">
              ${Array(5).fill(0).map((_, i) => `
                <i class="ri-${i < (rating.rating || 0) ? 'star-fill' : 'star-line'} text-yellow-400"></i>
              `).join('')}
              ${isAdmin ? `
                <button class="edit-rating text-blue-600 text-sm font-medium cursor-pointer ml-4" data-rating-id="${doc.id}">Modifier</button>
                <button class="delete-rating text-red-600 text-sm font-medium cursor-pointer ml-2" data-rating-id="${doc.id}">Supprimer</button>
              ` : ''}
            </div>
          </div>
          <p class="text-sm text-gray-700 mt-2">${rating.comment || 'Aucun commentaire'}</p>
        </div>
      `;
    });

    // Ajouter les écouteurs après le rendu
    document.querySelectorAll(".edit-rating").forEach(button => {
      button.addEventListener("click", () => editRating(button.getAttribute("data-rating-id")));
    });
    document.querySelectorAll(".delete-rating").forEach(button => {
      button.addEventListener("click", () => deleteRating(button.getAttribute("data-rating-id")));
    });
  } catch (error) {
    console.error("Error loading ratings:", error);
    ratingsList.innerHTML = '<p class="text-red-500">Erreur de chargement</p>';
  }
}

function editRating(ratingId) {
  const docRef = doc(db, "ratings", ratingId);
  getDoc(docRef).then(docSnap => {
    if (docSnap.exists()) {
      const rating = docSnap.data();
      const modal = document.createElement("div");
      modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
      modal.innerHTML = `
        <div class="bg-white rounded-md p-6 m-4 max-w-md w-full">
          <h3 class="text-md font-semibold text-gray-800 mb-4">Modifier l'évaluation</h3>
          <form id="editRatingForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Titre de l'événement</label>
              <input type="text" name="eventTitle" value="${rating.eventTitle || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Note (1-5)</label>
              <input type="number" name="rating" min="1" max="5" value="${rating.rating || 1}" required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Commentaire</label>
              <textarea name="comment" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">${rating.comment || ''}</textarea>
            </div>
            <div id="edit-error" class="text-red-500 text-sm hidden"></div>
            <div class="flex space-x-3 pt-4">
              <button type="button" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-button hover:bg-gray-200" id="cancelEditBtn">Annuler</button>
              <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-button hover:bg-primary/90">Sauvegarder</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      const form = modal.querySelector("#editRatingForm");
      const cancelBtn = modal.querySelector("#cancelEditBtn");
      const errorDiv = modal.querySelector("#edit-error");

      cancelBtn.onclick = () => modal.remove();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        try {
          await updateDoc(docRef, {
            eventTitle: data.eventTitle,
            rating: parseInt(data.rating),
            comment: data.comment,
            createdAt: serverTimestamp()
          });
          modal.remove();
          loadRatings(); // Recharger la liste des avis
        } catch (error) {
          console.error("Erreur lors de la modification:", error);
          errorDiv.textContent = `Erreur : ${error.message}`;
          errorDiv.classList.remove("hidden");
        }
      });
    } else {
      console.error("Évaluation non trouvée:", ratingId);
    }
  }).catch(error => console.error("Erreur de récupération:", error));
}

function deleteRating(ratingId) {
  if (confirm("Êtes-vous sûr de vouloir supprimer cette évaluation ?")) {
    const docRef = doc(db, "ratings", ratingId);
    deleteDoc(docRef)
      .then(() => {
        console.log("Évaluation supprimée avec succès");
        loadRatings(); // Recharger la liste des avis
      })
      .catch(error => console.error("Erreur lors de la suppression:", error));
  }
}

        // Filters
        const filterButton = document.getElementById("filter-btn");
        const filterModal = document.getElementById("filter-modal");
        const filterOptions = document.querySelectorAll(".filter-option");
        const closeFilterModal = document.getElementById("close-filter-modal");

        filterButton.addEventListener("click", () => {
          filterModal.classList.remove("hidden");
        });

        filterOptions.forEach(option => {
          option.addEventListener("click", function () {
            const filter = this.getAttribute("data-filter");
            loadCalendar(filter);
            filterModal.classList.add("hidden");
          });
        });

        closeFilterModal.addEventListener("click", () => {
          filterModal.classList.add("hidden");
        });

        // Month navigation
        document.getElementById("prev-month").addEventListener("click", () => {
          currentMonth.setMonth(currentMonth.getMonth() - 1);
          selectedDay = 1; // Réinitialiser au 1er jour du mois
          loadCalendar();
        });

        document.getElementById("next-month").addEventListener("click", () => {
          currentMonth.setMonth(currentMonth.getMonth() + 1);
          selectedDay = 1; // Réinitialiser au 1er jour du mois
          loadCalendar();
        });

        // Add/Edit Event
        function createEventModal(eventData = null, isLive = false) {
  const isEdit = !!eventData;
  const defaultData = {
    title: '',
    date: '',
    endDate: '',
    type: isLive ? 'Live' : 'Live',
    startTime: '',
    endTime: '',
    location: '',
    description: '',
    youtubeUrl: ''
  };
  const safeEventData = { ...defaultData, ...eventData };

  let formattedDate = '';
  let formattedEndDate = '';
  if (isEdit && safeEventData.date && safeEventData.date.toDate) {
    try {
      formattedDate = safeEventData.date.toDate().toISOString().split('T')[0];
      formattedEndDate = safeEventData.endDate && safeEventData.endDate.toDate
        ? safeEventData.endDate.toDate().toISOString().split('T')[0]
        : formattedDate;
    } catch (e) {
      console.error("Erreur de formatage de la date:", e);
    }
  }

  const modal = document.createElement("div");
  modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
  modal.innerHTML = `
    <div class="bg-white rounded-md p-6 m-4 max-w-md w-full">
      <form id="eventForm" class="space-y-4">
        <h3 class="text-md font-semibold text-gray-800 mb-4">${isEdit ? 'Modifier un événement' : isLive ? 'Ajouter un live' : 'Ajouter un événement'}</h3>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Titre</label>
          <input type="text" name="title" value="${safeEventData.title}" required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Date de début</label>
            <input type="date" name="date" value="${formattedDate}" required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Date de fin (optionnel)</label>
            <input type="date" name="endDate" value="${formattedEndDate}" class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
            <select name="type" ${isLive ? 'disabled' : ''} required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
              <option value="Live" ${isLive || safeEventData.type === 'Live' ? 'selected' : ''}>Live</option>
              <option value="Visite" ${safeEventData.type === 'Visite' ? 'selected' : ''}>Visite</option>
              <option value="Food" ${safeEventData.type === 'Food' ? 'selected' : ''}>Food</option>
              <option value="Nocturne" ${safeEventData.type === 'Nocturne' ? 'selected' : ''}>Nocturne</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Heure de début</label>
            <input type="time" name="startTime" value="${safeEventData.startTime}" required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Heure de fin</label>
            <input type="time" name="endTime" value="${safeEventData.endTime}" required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Lieu</label>
            <input type="text" name="location" value="${safeEventData.location}" required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <textarea name="description" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">${safeEventData.description}</textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">URL YouTube (optionnel)</label>
          <input type="url" name="youtubeUrl" value="${safeEventData.youtubeUrl || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div id="event-error" class="text-red-500 text-sm hidden"></div>
        <div class="flex space-x-3 pt-4">
          <button type="button" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-button hover:bg-gray-200" id="cancelEventBtn">Annuler</button>
          <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-button hover:bg-primary/90">${isEdit ? 'Modifier' : 'Enregistrer'}</button>
        </div>
      </form>
    </div>
  `;
  document.body.appendChild(modal);
  const form = document.getElementById("eventForm");
  const cancelBtn = document.getElementById("cancelEventBtn");
  const errorDiv = document.getElementById("event-error");
  cancelBtn.addEventListener("click", () => modal.remove());

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!currentUser || userRole !== "admin") {
      errorDiv.textContent = "Vous devez être administrateur pour effectuer cette action";
      errorDiv.classList.remove("hidden");
      return;
    }

    const formData = new FormData(form);
    const eventData = Object.fromEntries(formData.entries());
    try {
      const eventDate = new Date(eventData.date);
      const endDate = eventData.endDate ? new Date(eventData.endDate) : eventDate;
      if (isNaN(eventDate)) {
        throw new Error("Format de date de début invalide");
      }
      if (eventData.endDate && isNaN(endDate)) {
        throw new Error("Format de date de fin invalide");
      }
      if (eventData.endDate && endDate < eventDate) {
        throw new Error("La date de fin ne peut pas être antérieure à la date de début");
      }

      const dataToSave = {
        title: eventData.title || "Sans titre",
        date: eventDate,
        endDate: eventData.endDate ? endDate : null,
        type: isLive ? "Live" : eventData.type,
        startTime: eventData.startTime || "00:00",
        endTime: eventData.endTime || "00:00",
        location: eventData.location || "Non spécifié",
        description: eventData.description || "Aucune description",
        youtubeUrl: eventData.youtubeUrl || null,
        createdBy: currentUser.uid,
        createdAt: serverTimestamp()
      };

      if (isEdit) {
        const eventRef = doc(db, "events", safeEventData.id);
        await updateDoc(eventRef, {
          ...dataToSave,
          updatedBy: currentUser.uid,
          updatedAt: serverTimestamp()
        });
      } else {
        await setDoc(doc(collection(db, "events")), dataToSave);
      }

      const successModal = document.createElement("div");
      successModal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
      successModal.innerHTML = `
        <div class="bg-white rounded-md p-6 m-4 max-w-sm w-full">
          <div class="text-center">
            <div class="w-12 h-12 rounded-full bg-green-100 mx-auto mb-4 flex items-center justify-center">
              <i class="ri-check-line text-green-500 text-2xl"></i>
            </div>
            <h4 class="text-md font-semibold text-gray-800 mb-2">Événement ${isEdit ? 'modifié' : 'créé'}</h4>
            <p class="text-gray-600 mb-4">L'événement a été ${isEdit ? 'modifié' : 'ajouté'} avec succès.</p>
            <button class="w-full bg-primary text-white py-2 rounded-button">Fermer</button>
          </div>
        </div>
      `;
      modal.remove();
      document.body.appendChild(successModal);
      successModal.querySelector("button").onclick = () => {
        successModal.remove();
        loadCalendar();
        loadHomePage();
      };
    } catch (error) {
      console.error(`Error ${isEdit ? 'updating' : 'adding'} event:`, error);
      errorDiv.textContent = `Erreur: ${error.message.includes("permission") ? "Permissions insuffisantes" : error.message}`;
      errorDiv.classList.remove("hidden");
    }
  });
}

        async function editEvent(eventId) {
  try {
    const docRef = doc(db, "events", eventId);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      const eventData = docSnap.data();
      const validatedEventData = {
        id: docSnap.id,
        title: eventData.title || '',
        date: eventData.date && eventData.date.toDate ? eventData.date : null,
        endDate: eventData.endDate && eventData.endDate.toDate ? eventData.endDate : null,
        type: eventData.type || 'Live',
        startTime: eventData.startTime || '',
        endTime: eventData.endTime || '',
        location: eventData.location || '',
        description: eventData.description || '',
        youtubeUrl: eventData.youtubeUrl || ''
      };
      createEventModal(validatedEventData, validatedEventData.type === "Live");
    } else {
      throw new Error("L'événement n'existe pas");
    }
  } catch (error) {
    console.error("Error loading event for edit:", error);
    const errorModal = document.createElement("div");
    errorModal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
    errorModal.innerHTML = `
      <div class="bg-white rounded-md p-6 m-4 max-w-sm w-full">
        <h4 class="font-bold text-md mb-4">Erreur</h4>
        <p class="text-gray-600 mb-4">Impossible de charger l'événement: ${error.message}</p>
        <button class="w-full bg-primary text-white py-2 rounded-button">Fermer</button>
      </div>
    `;
    document.body.appendChild(errorModal);
    errorModal.querySelector("button").onclick = () => errorModal.remove();
  }
}

        async function deleteEvent(eventId) {
          if (!currentUser || userRole !== "admin") {
            alert("Vous devez être administrateur pour effectuer cette action");
            return;
          }

          if (!confirm("Voulez-vous vraiment supprimer cet événement ?")) return;

          try {
            await deleteDoc(doc(db, "events", eventId));
            const successModal = document.createElement("div");
            successModal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
            successModal.innerHTML = `
              <div class="bg-white rounded-md p-6 m-4 max-w-sm w-full">
                <div class="text-center">
                  <div class="w-12 h-12 rounded-full bg-green-100 mx-auto mb-4 flex items-center justify-center">
                    <i class="ri-check-line text-green-500 text-2xl"></i>
                  </div>
                  <h4 class="text-md font-semibold text-gray-800 mb-2">Événement supprimé</h4>
                  <p class="text-gray-600 mb-4">L'événement a été supprimé avec succès.</p>
                  <button class="w-full bg-primary text-white py-2 rounded-button">Fermer</button>
                </div>
              </div>
            `;
            document.body.appendChild(successModal);
            successModal.querySelector("button").onclick = () => {
              successModal.remove();
              loadCalendar();
              loadHomePage();
            };
          } catch (error) {
            console.error("Error deleting event:", error);
            alert("Erreur lors de la suppression de l'événement");
          }
        }

        // Add Event
        const addEventButton = document.getElementById("add-event-btn");
        addEventButton.addEventListener("click", () => createEventModal());

        // Add Rating
        const addRatingButton = document.getElementById("add-rating-btn");
        addRatingButton.addEventListener("click", () => {
          if (!currentUser || userRole !== "admin") {
            alert("Vous devez être administrateur pour ajouter une évaluation");
            return;
          }

          const modal = document.createElement("div");
          modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
          modal.innerHTML = `
            <div class="bg-white rounded-md p-6 m-4 max-w-md w-full">
              <form id="ratingForm" class="space-y-4">
                <h3 class="text-md font-semibold text-gray-800 mb-4">Ajouter une évaluation</h3>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Événement</label>
                  <select name="eventTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">Sélectionnez un événement</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
                  <select name="rating" required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="1">1 étoile</option>
                    <option value="2">2 étoiles</option>
                    <option value="3">3 étoiles</option>
                    <option value="4">4 étoiles</option>
                    <option value="5">5 étoiles</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Commentaire</label>
                  <textarea name="comment" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-button focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                </div>
                <div id="rating-error" class="text-red-500 text-sm hidden"></div>
                <div class="flex space-x-3 pt-4">
                  <button type="button" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-button hover:bg-gray-200" id="cancelRatingBtn">Annuler</button>
                  <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-button hover:bg-primary/90">Enregistrer</button>
                </div>
              </form>
            </div>
          `;          document.body.appendChild(modal);
          const form = modal.querySelector("#ratingForm");
          const cancelBtn = modal.querySelector("#cancelRatingBtn");
          const errorDiv = modal.querySelector("#rating-error");
          // Charger les événements pour le menu déroulant
          async function loadEventsForRating() {
            try {
              const eventQuery = query(collection(db, "events"), 
              orderBy("date", "desc"), 
              limit(20));
              const eventSnapshot = await getDocs(eventQuery);
              const eventSelect = form.querySelector("select[name='eventTitle']");
              eventSnapshot.forEach(doc => {
                const event = doc.data();
                const option = document.createElement("option");
                option.value = event.title || "Sans titre";
                option.textContent = `${event.title || 'Sans titre'} (${event.date && event.date.toDate ? event.date.toDate().toLocaleDateString('fr-FR') : 'N/A date'})`;
                eventSelect.appendChild(option);
              });
            } catch (error) {
              console.error("Erreur lors du chargement des événements pour l'évaluation :", error);
              errorDiv.textContent = "Erreur lors du chargement des événements.";
              errorDiv.classList.remove("hidden");
            }
          }

          loadEventsForRating();

          cancelBtn.onclick = () => modal.remove();

          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const ratingData = Object.fromEntries(formData.entries());

            try {
              if (!ratingData.eventTitle || !ratingData.rating || !ratingData.comment) {
                throw new Error("Tous les champs sont requis.");
              }

              await setDoc(doc(collection(db, "ratings")), {
                eventTitle: ratingData.eventTitle,
                rating: parseInt(ratingData.rating),
                comment: ratingData.comment,
                createdBy: currentUser.uid,
                createdAt: serverTimestamp()
              });

              modal.remove();
              const successModal = document.createElement("div");
              successModal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
              successModal.innerHTML = `
                <div class="bg-white rounded-md p-6 m-4 max-w-sm w-full">
                  <div class="text-center">
                    <div class="w-12 h-12 rounded-full bg-green-100 mx-auto mb-4 flex items-center justify-center">
                      <i class="ri-check-line text-green-500 text-2xl"></i>
                    </div>
                    <h4 class="text-md font-semibold text-gray-800 mb-2">Évaluation ajoutée</h4>
                    <p class="text-gray-600 mb-4">L'évaluation a été ajoutée avec succès.</p>
                    <button class="w-full bg-primary text-white py-2 rounded-button">Fermer</button>
                  </div>
                </div>
              `;
              document.body.appendChild(successModal);
              successModal.querySelector("button").onclick = () => {
                successModal.remove();
                loadRatings();
              };
            } catch (error) {
              console.error("Erreur lors de l'ajout de l'évaluation :", error);
              errorDiv.textContent = `Erreur : ${error.message}`;
              errorDiv.classList.remove("hidden");
            }
          });
        });

        // Gestion des erreurs globales
        window.addEventListener("unhandledrejection", (event) => {
          console.error("Erreur non gérée :", event.reason);
          // Optionnel : Afficher une alerte utilisateur
          // alert("Une erreur inattendue s'est produite. Veuillez réessayer.");
        });

        // Optimisation du défilement pour les listes longues
        function optimizeScroll(container) {
          let ticking = false;
          container.addEventListener("scroll", () => {
            if (!ticking) {
              window.requestAnimationFrame(() => {
                // Logique de chargement paresseux ou autre optimisation si nécessaire
                ticking = false;
              });
              ticking = true;
            }
          });
        }

        optimizeScroll(document.getElementById("live-events"));
        optimizeScroll(document.getElementById("news-section"));
        optimizeScroll(document.getElementById("event-list"));
        optimizeScroll(document.getElementById("upcoming-events"));
        optimizeScroll(document.getElementById("ratings-list"));

        // Initialisation des données au démarrage
        loadHomePage();
        loadCalendar();
        loadRatings();
      });
    </script>
    <script src="main.js"></script>
  </body>
</html>
